name: ðŸ“š Deploy Documentation

on:
  push:
    branches: [main]
    paths:
      - "docs/**"
      - ".github/workflows/docs.yml"
      - "README.md"
      - "goal-kit/README.md"
  workflow_dispatch:

env:
  NODE_VERSION: "20"

jobs:
  build-docs:
    name: ðŸ“ Build Documentation
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ›’ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Install Documentation Tools
        run: |
          npm install -g markdownlint-cli prettier
          sudo apt-get install -y pandoc texlive-latex-base texlive-fonts-recommended

      - name: ðŸ“ Validate Documentation
        run: |
          echo "ðŸ“ Validating documentation files..."

          # Check README files
          if [ -f "README.md" ]; then
            echo "âœ… Found main README.md"
            markdownlint README.md || echo "Linting issues found in README.md"
          fi

          if [ -f "goal-kit/README.md" ]; then
            echo "âœ… Found goal-kit README.md"
            markdownlint goal-kit/README.md || echo "Linting issues found in goal-kit README.md"
          fi

          # Check template documentation
          find goal-kit/templates -name "*.md" -exec echo "ðŸ“„ Validating {}" \; -exec markdownlint {} \; || echo "Some template files have linting issues"

          echo "âœ… Documentation validation completed"

      - name: ðŸŽ¨ Format Documentation
        run: |
          echo "ðŸŽ¨ Formatting documentation..."

          # Format main README
          if [ -f "README.md" ]; then
            prettier --write README.md 2>/dev/null || echo "Could not format README.md"
          fi

          # Format goal-kit README
          if [ -f "goal-kit/README.md" ]; then
            prettier --write goal-kit/README.md 2>/dev/null || echo "Could not format goal-kit README.md"
          fi

          echo "âœ… Documentation formatting completed"

      - name: ðŸ“‹ Generate Documentation Index
        run: |
          echo "ðŸ“‹ Generating documentation index..."

          cat > docs/README.md << 'EOF'
          # Goal-Kit Documentation

          ## ðŸ“š Documentation Overview

          This directory contains comprehensive documentation for Goal-Kit, a goal management template system for AI agents.

          ## ðŸ“– Available Documentation

          ### ðŸš€ Getting Started
          - [Main README](../README.md) - Overview and quick start
          - [Installation Guide](installation.md) - Setup instructions
          - [Quick Start Guide](quickstart.md) - Fast track to using Goal-Kit

          ### ðŸ¤– AI Agent Integration
          - [Cursor Integration](cursor-integration.md) - Using with Cursor
          - [Claude Integration](claude-integration.md) - Using with Claude
          - [Qwen Integration](qwen-integration.md) - Using with Qwen
          - [Roo Integration](roo-integration.md) - Using with Roo

          ### ðŸ› ï¸ Development
          - [Template Development](template-development.md) - Creating custom templates
          - [Script Development](script-development.md) - Writing automation scripts
          - [Contributing Guide](../goal-kit/CONTRIBUTING.md) - How to contribute

          ### ðŸ“‹ Reference
          - [Template Reference](template-reference.md) - Complete template documentation
          - [Script Reference](script-reference.md) - All available scripts
          - [Command Reference](command-reference.md) - AI agent commands
          - [API Reference](api-reference.md) - Programmatic interface

          ## ðŸ“ Directory Structure

          ```
          docs/
          â”œâ”€â”€ README.md                 # This file
          â”œâ”€â”€ installation.md          # Installation guide
          â”œâ”€â”€ quickstart.md            # Quick start guide
          â”œâ”€â”€ development/
          â”‚   â”œâ”€â”€ template-dev.md      # Template development
          â”‚   â”œâ”€â”€ script-dev.md        # Script development
          â”‚   â””â”€â”€ testing.md           # Testing guide
          â”œâ”€â”€ integration/
          â”‚   â”œâ”€â”€ cursor.md            # Cursor-specific docs
          â”‚   â”œâ”€â”€ claude.md            # Claude-specific docs
          â”‚   â””â”€â”€ qwen.md              # Qwen-specific docs
          â””â”€â”€ reference/
              â”œâ”€â”€ templates.md         # Template reference
              â”œâ”€â”€ scripts.md           # Script reference
              â””â”€â”€ commands.md          # Command reference
          ```

          ## ðŸš€ Quick Links

          - [ðŸ™ GitHub Repository](https://github.com/your-repo/goal-kit)
          - [ðŸ“¦ Latest Release](https://github.com/your-repo/goal-kitreleases/latest)
          - [ðŸ› Report Issues](https://github.com/your-repo/goal-kit/issues)
          - [ðŸ’¬ Discussions](https://github.com/your-repo/goal-kit/discussions)

          ---

          *Documentation last updated: $(date -u)*
          EOF

          echo "âœ… Documentation index generated"

      - name: ðŸ“Š Generate Documentation Stats
        run: |
          echo "ðŸ“Š Generating documentation statistics..."

          cat > docs/documentation-stats.md << EOF
          # Documentation Statistics

          ## ðŸ“ˆ Overview
          Generated: $(date -u)

          ## ðŸ“Š File Statistics
          EOF

          # Count different file types
          echo "### File Types" >> docs/documentation-stats.md
          echo "| Type | Count | Total Size |" >> docs/documentation-stats.md
          echo "|------|-------|------------|" >> docs/documentation-stats.md

          # Markdown files
          md_count=$(find . -name "*.md" -not -path "./node_modules/*" -not -path "./.git/*" | wc -l)
          md_size=$(find . -name "*.md" -not -path "./node_modules/*" -not -path "./.git/*" -exec ls -la {} \; | awk '{sum+=$5} END{print sum}')
          echo "| Markdown | $md_count | $(numfmt --to=iec $md_size) |" >> docs/documentation-stats.md

          # JSON files
          json_count=$(find . -name "*.json" -not -path "./node_modules/*" -not -path "./.git/*" | wc -l)
          json_size=$(find . -name "*.json" -not -path "./node_modules/*" -not -path "./.git/*" -exec ls -la {} \; | awk '{sum+=$5} END{print sum}')
          echo "| JSON | $json_count | $(numfmt --to=iec $json_size) |" >> docs/documentation-stats.md

          # Shell scripts
          sh_count=$(find . -name "*.sh" -not -path "./node_modules/*" -not -path "./.git/*" | wc -l)
          sh_size=$(find . -name "*.sh" -not -path "./node_modules/*" -not -path "./.git/*" -exec ls -la {} \; | awk '{sum+=$5} END{print sum}')
          echo "| Shell Scripts | $sh_count | $(numfmt --to=iec $sh_size) |" >> docs/documentation-stats.md

          # PowerShell scripts
          ps_count=$(find . -name "*.ps1" -not -path "./node_modules/*" -not -path "./.git/*" | wc -l)
          ps_size=$(find . -name "*.ps1" -not -path "./node_modules/*" -not -path "./.git/*" -exec ls -la {} \; | awk '{sum+=$5} END{print sum}')
          echo "| PowerShell Scripts | $ps_count | $(numfmt --to=iec $ps_size) |" >> docs/documentation-stats.md

          # TOML files
          toml_count=$(find . -name "*.toml" -not -path "./node_modules/*" -not -path "./.git/*" | wc -l)
          toml_size=$(find . -name "*.toml" -not -path "./node_modules/*" -not -path "./.git/*" -exec ls -la {} \; | awk '{sum+=$5} END{print sum}')
          echo "| TOML | $toml_count | $(numfmt --to=iec $toml_size) |" >> docs/documentation-stats.md

          echo "" >> docs/documentation-stats.md
          echo "## ðŸ“ Documentation Quality" >> docs/documentation-stats.md

          # Check for common documentation issues
          echo "### Quality Checks" >> docs/documentation-stats.md
          echo "- README files: $(find . -name "README.md" | wc -l)" >> docs/documentation-stats.md
          echo "- License file: $(if [ -f "LICENSE" ]; then echo "âœ… Present"; else echo "âŒ Missing"; fi)" >> docs/documentation-stats.md
          echo "- Contributing guide: $(if [ -f "CONTRIBUTING.md" ]; then echo "âœ… Present"; else echo "âŒ Missing"; fi)" >> docs/documentation-stats.md

          echo "" >> docs/documentation-stats.md
          echo "## ðŸŽ¯ Documentation Score" >> docs/documentation-stats.md
          total_score=0
          max_score=10

          [ $md_count -gt 5 ] && ((total_score+=2)) || ((total_score+=1))
          [ -f "README.md" ] && ((total_score+=2))
          [ -f "LICENSE" ] && ((total_score+=2))
          [ -f "CONTRIBUTING.md" ] && ((total_score+=2))
          [ $json_count -gt 0 ] && ((total_score+=1))
          [ $sh_count -gt 0 ] && ((total_score+=1))

          echo "**Score: $total_score/$max_score**" >> docs/documentation-stats.md

          if [ $total_score -ge 8 ]; then
            echo "**Rating: ðŸŸ¢ Excellent**" >> docs/documentation-stats.md
          elif [ $total_score -ge 6 ]; then
            echo "**Rating: ðŸŸ¡ Good**" >> docs/documentation-stats.md
          else
            echo "**Rating: ðŸ”´ Needs Improvement**" >> docs/documentation-stats.md
          fi

          echo "" >> docs/documentation-stats.md
          echo "ðŸ“… Last updated: $(date -u)" >> docs/documentation-stats.md

          echo "âœ… Documentation statistics generated"

  deploy-docs:
    name: ðŸš€ Deploy Documentation
    runs-on: ubuntu-latest
    needs: build-docs
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: ðŸ›’ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“¤ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          cname: docs.goal-kit.dev # Optional: custom domain

      - name: ðŸ“‹ Generate Deployment Summary
        run: |
          echo "ðŸš€ Documentation Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“š Deployment Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed to:** GitHub Pages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ðŸ“„ Files Deployed" >> $GITHUB_STEP_SUMMARY
          find docs -type f -name "*.md" | while read file; do
            echo "- âœ… $file" >> $GITHUB_STEP_SUMMARY
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”— Access URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Documentation Site:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** https://github.com/${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ðŸ“‹ Deployment Status: âœ… SUCCESS" >> $GITHUB_STEP_SUMMARY
